<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SimpleTax NG - Tax Filing Assistant</title>
  <style>
    /* Atlassian Design System inspired colors and tokens */
    :root {
      --color-text: #172B4D;
      --color-text-subtle: #42526E;
      --color-background-neutral: #F4F5F7;
      --color-background-selected-bold-blue: #0C66E4;
      --color-background-white: #FFFFFF;
      --color-border: #DFE1E6;
      --color-border-focus: #0052CC;
      --color-background-danger: #DE350B;
      --color-background-success: #00875A;
      --color-background-warning: #FF991F;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      --spacing-xxl: 32px;
      --radius-sm: 3px;
      --radius-md: 6px;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--spacing-lg);
      color: var(--color-text);
    }

    .mobile-container {
      width: 100%;
      max-width: 420px;
      background: var(--color-background-white);
      border-radius: var(--spacing-xl);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      display: flex;
      flex-direction: column;
      height: 90vh;
      max-height: 800px;
      overflow: hidden;
    }

    .header {
      background: var(--color-background-white);
      padding: var(--spacing-xl) var(--spacing-lg);
      border-bottom: 1px solid var(--color-border);
      text-align: center;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
    }

    .header p {
      font-size: 14px;
      color: var(--color-text-subtle);
    }

    .progress-bar {
      height: 4px;
      background: var(--color-border);
      margin-top: var(--spacing-md);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--color-background-selected-bold-blue);
      transition: width 0.3s ease;
    }

    .conversation-area {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-lg);
      background: var(--color-background-neutral);
    }

    .conversation-stream {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .message-row {
      display: flex;
      width: 100%;
    }

    .message-row.message-assistant {
      justify-content: flex-start;
    }

    .message-row.message-user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 75%;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .bubble-assistant {
      background: var(--color-background-white);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .bubble-user {
      background: var(--color-background-selected-bold-blue);
      color: #FFFFFF;
    }

    .chat-card {
      background: var(--color-background-white);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--spacing-xl);
      margin-top: var(--spacing-md);
    }

    .assistant-bubble {
      background: var(--color-background-neutral);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-xl);
      font-size: 14px;
      line-height: 1.5;
      color: var(--color-text);
    }

    .reassurance-text {
      font-size: 13px;
      color: var(--color-text-subtle);
      font-style: italic;
      margin-top: var(--spacing-sm);
    }

    .form-group {
      margin-bottom: var(--spacing-xl);
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--spacing-sm);
    }

    .form-group label .required {
      color: var(--color-background-danger);
      margin-left: var(--spacing-xs);
    }

    .form-group .helper {
      font-size: 12px;
      color: var(--color-text-subtle);
      margin-top: var(--spacing-xs);
      font-weight: normal;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: var(--font-family);
      color: var(--color-text);
      background: var(--color-background-white);
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-border-focus);
    }

    .form-input::placeholder {
      color: var(--color-text-subtle);
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      background: var(--color-background-neutral);
      border-color: var(--color-border-focus);
    }

    .checkbox-item input[type="checkbox"] {
      margin-top: 2px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .checkbox-item label {
      font-weight: normal;
      cursor: pointer;
      flex: 1;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .radio-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-item:hover {
      background: var(--color-background-neutral);
      border-color: var(--color-border-focus);
    }

    .radio-item input[type="radio"] {
      margin-top: 2px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .radio-item label {
      font-weight: normal;
      cursor: pointer;
      flex: 1;
    }

    .button-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
    }

    .button {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-lg);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      font-family: var(--font-family);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .button-primary {
      background: var(--color-background-selected-bold-blue);
      color: #FFFFFF;
    }

    .button-primary:hover {
      background: #0052CC;
    }

    .button-subtle {
      background: var(--color-background-neutral);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .button-subtle:hover {
      background: #EBECF0;
    }

    .button-full {
      width: 100%;
    }

    .helper-text {
      font-size: 12px;
      color: var(--color-text-subtle);
      margin-top: var(--spacing-md);
      text-align: center;
    }

    .results-card {
      background: var(--color-background-white);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }

    .results-section {
      margin-bottom: var(--spacing-xl);
    }

    .results-section:last-child {
      margin-bottom: 0;
    }

    .results-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--color-border);
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-md) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-label {
      font-size: 14px;
      color: var(--color-text-subtle);
    }

    .result-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
      text-align: right;
    }

    .result-value.highlight {
      color: var(--color-background-selected-bold-blue);
      font-size: 18px;
    }

    .flag {
      background: #FFF4E5;
      border-left: 3px solid var(--color-background-warning);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      margin-top: var(--spacing-md);
      font-size: 13px;
      line-height: 1.5;
    }

    .flag.info {
      background: #E3FCEF;
      border-left-color: var(--color-background-success);
    }

    .summary-actions {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
    }

    .footer {
      padding: var(--spacing-md) var(--spacing-lg);
      text-align: center;
      font-size: 12px;
      color: var(--color-text-subtle);
      border-top: 1px solid var(--color-border);
      background: var(--color-background-white);
    }

    @media (min-width: 768px) {
      body {
        padding: var(--spacing-xl);
      }
    }

    .conversation-area {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <div class="header">
      <h1>SimpleTax NG</h1>
      <p>Your tax filing companion</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
      </div>
    </div>

    <div class="conversation-area" id="conversationArea">
      <div class="conversation-stream" id="conversationStream">
        <!-- Messages and forms will be inserted here -->
      </div>
    </div>

    <div class="footer">
      <p>Tax guidance tool. Always consult a tax professional before filing.</p>
    </div>
  </div>

  <script>
    // ==================== NIGERIAN TAX ENGINE (PITA) ====================
    const NigerianTaxEngine = {
      // Progressive tax bands for Personal Income Tax (PITA)
      taxBands: [
        { min: 0, max: 300000, rate: 0.07 },
        { min: 300000, max: 600000, rate: 0.11 },
        { min: 600000, max: 1100000, rate: 0.15 },
        { min: 1100000, max: 1600000, rate: 0.19 },
        { min: 1600000, max: 3200000, rate: 0.21 },
        { min: 3200000, max: Infinity, rate: 0.24 }
      ],

      // Calculate Consolidated Relief Allowance (CRA)
      calculateCRA(grossIncome) {
        // CRA = 20% of gross income + â‚¦200,000
        const twentyPercent = grossIncome * 0.20;
        const fixedAmount = 200000;
        return twentyPercent + fixedAmount;
      },

      // Calculate taxable income
      calculateTaxableIncome(profile) {
        let grossIncome = 0;

        // Add salary income
        if (profile.hasSalary && profile.annualSalary) {
          grossIncome += this.parseAmount(profile.annualSalary);
        }

        // Add freelance/business income
        if (profile.hasFreelance && profile.freelanceIncome) {
          grossIncome += this.parseAmount(profile.freelanceIncome);
        }

        // Add foreign income
        if (profile.hasForeignIncome && profile.foreignIncome) {
          grossIncome += this.parseAmount(profile.foreignIncome);
        }

        // Calculate CRA
        const cra = this.calculateCRA(grossIncome);

        // Calculate taxable income (gross income - CRA)
        const taxableIncome = Math.max(0, grossIncome - cra);

        return {
          grossIncome,
          cra,
          taxableIncome
        };
      },

      // Calculate tax using progressive bands
      calculateTax(profile) {
        const calc = this.calculateTaxableIncome(profile);
        
        if (calc.taxableIncome <= 0) {
          return {
            ...calc,
            taxLiability: 0,
            payeOffset: 0,
            finalTax: 0,
            effectiveRate: 0
          };
        }

        // Calculate tax using progressive bands
        let taxLiability = 0;
        let remainingIncome = calc.taxableIncome;

        for (const band of this.taxBands) {
          if (remainingIncome <= 0) break;
          
          const taxableInBand = Math.min(remainingIncome, band.max - band.min);
          taxLiability += taxableInBand * band.rate;
          remainingIncome -= taxableInBand;
        }

        // Apply PAYE offset if applicable
        const payeDeducted = profile.payeDeducted ? this.parseAmount(profile.payeDeducted) : 0;
        const finalTax = Math.max(0, taxLiability - payeDeducted);

        // Calculate effective rate
        const effectiveRate = calc.grossIncome > 0 ? (taxLiability / calc.grossIncome) * 100 : 0;

        return {
          ...calc,
          taxLiability,
          payeOffset: payeDeducted,
          finalTax,
          effectiveRate: effectiveRate.toFixed(1)
        };
      },

      // Get state IRS information
      getStateIRS(state) {
        const stateIRS = {
          'lagos': {
            name: 'Lagos State Internal Revenue Service (LIRS)',
            address: 'Block 12, Alausa Secretariat, Ikeja, Lagos',
            website: 'https://lirs.gov.ng',
            phone: '+234 1 270 0000'
          },
          'abuja': {
            name: 'Federal Capital Territory Internal Revenue Service (FCT-IRS)',
            address: 'Area 11, Garki, Abuja',
            website: 'https://fctirs.gov.ng',
            phone: '+234 9 234 5678'
          },
          'rivers': {
            name: 'Rivers State Internal Revenue Service',
            address: 'Port Harcourt, Rivers State',
            website: 'https://rirs.gov.ng',
            phone: '+234 84 123 456'
          },
          'kano': {
            name: 'Kano State Internal Revenue Service',
            address: 'Kano, Kano State',
            website: 'https://kano-irs.gov.ng',
            phone: '+234 64 123 456'
          }
        };

        return stateIRS[state?.toLowerCase()] || {
          name: `${state} State Internal Revenue Service`,
          address: 'Contact your state IRS office',
          website: 'Check your state government website',
          phone: 'Contact your state IRS'
        };
      },

      // Format Nigerian Naira
      formatCurrency(amount) {
        return `â‚¦${amount.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      },

      // Parse amount string to number
      parseAmount(amountStr) {
        if (!amountStr) return 0;
        const cleaned = String(amountStr).replace(/[^\d.-]/g, '');
        const num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
      }
    };

    // ==================== INTERVIEW FLOW ====================
    const interviewSteps = [
      'welcome',
      'residency',
      'incomeType',
      'salary',
      'freelance',
      'foreignIncome',
      'reliefs',
      'taxHistory',
      'review',
      'compliance',
      'output'
    ];

    const state = {
      currentStepIndex: 0,
      profile: {},
      messages: [
        {
          id: 'm1',
          author: 'assistant',
          text: "Hi! Welcome to SimpleTax NG. I'm here to help you file your personal income tax in Nigeria. Don't worryâ€”I'll ask simple questions in plain language. Let's get started!"
        }
      ]
    };

    // Nigerian states
    const nigerianStates = [
      'Abia', 'Adamawa', 'Akwa Ibom', 'Anambra', 'Bauchi', 'Bayelsa', 'Benue', 'Borno',
      'Cross River', 'Delta', 'Ebonyi', 'Edo', 'Ekiti', 'Enugu', 'Gombe', 'Imo',
      'Jigawa', 'Kaduna', 'Kano', 'Katsina', 'Kebbi', 'Kogi', 'Kwara', 'Lagos',
      'Nasarawa', 'Niger', 'Ogun', 'Ondo', 'Osun', 'Oyo', 'Plateau', 'Rivers',
      'Sokoto', 'Taraba', 'Yobe', 'Zamfara', 'Abuja (FCT)'
    ];

    // Utility functions
    function updateProgress() {
      const progress = ((state.currentStepIndex + 1) / interviewSteps.length) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
    }

    function addMessage(author, text) {
      state.messages.push({
        id: `msg-${Date.now()}-${Math.random()}`,
        author,
        text
      });
      render();
    }

    function goToNext(nextStep, userMessage) {
      if (userMessage) {
        addMessage('user', userMessage);
      }
      const stepIndex = interviewSteps.indexOf(nextStep);
      if (stepIndex !== -1) {
        state.currentStepIndex = stepIndex;
      }
      render();
      scrollToBottom();
      updateProgress();
    }

    function goToPrevious() {
      if (state.currentStepIndex > 0) {
        state.currentStepIndex--;
        render();
        scrollToBottom();
        updateProgress();
      }
    }

    function scrollToBottom() {
      const area = document.getElementById('conversationArea');
      setTimeout(() => {
        area.scrollTop = area.scrollHeight;
      }, 100);
    }

    // Render functions
    function renderMessage(message) {
      return `
        <div class="message-row message-${message.author}">
          <div class="message-bubble bubble-${message.author}">
            ${escapeHtml(message.text)}
          </div>
        </div>
      `;
    }

    function renderWelcome() {
      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            This tool will guide you through filing your personal income tax. I'll ask about your income, expenses, and other details. Most people complete this in under 20 minutes.
          </p>
          <p class="reassurance-text">ðŸ’¡ Estimate is fine. You're doing great!</p>
          <button class="button button-primary button-full" onclick="goToNext('residency')">
            Let's begin
          </button>
          <p class="helper-text">Your data stays in your browser and is never sent anywhere</p>
        </div>
      `;
    }

    function renderResidency() {
      const stateOptions = nigerianStates.map(s => 
        `<option value="${s}" ${state.profile.currentState === s ? 'selected' : ''}>${escapeHtml(s)}</option>`
      ).join('');

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            First, let's determine which State Internal Revenue Service (IRS) you'll submit to.
          </p>
          <form onsubmit="handleResidency(event)">
            <div class="form-group">
              <label>
                Which state do you currently live in?
                <span class="required">*</span>
              </label>
              <select class="form-select" name="currentState" required>
                <option value="">Select your state</option>
                ${stateOptions}
              </select>
            </div>
            <div class="form-group">
              <label>
                Which state did you live in for most of last year?
                <span class="required">*</span>
                <span class="helper">This determines your primary tax jurisdiction</span>
              </label>
              <select class="form-select" name="primaryState" required>
                <option value="">Select state</option>
                ${stateOptions}
              </select>
            </div>
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Continue</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderIncomeType() {
      const hasSalary = state.profile.incomeTypes?.includes('salary') || false;
      const hasFreelance = state.profile.incomeTypes?.includes('freelance') || false;
      const hasBusiness = state.profile.incomeTypes?.includes('business') || false;
      const hasForeign = state.profile.incomeTypes?.includes('foreign') || false;

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            What types of income did you earn last year? You can select multiple options.
          </p>
          <form onsubmit="handleIncomeType(event)">
            <div class="form-group">
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" name="incomeType" value="salary" id="incomeSalary" ${hasSalary ? 'checked' : ''}>
                  <label for="incomeSalary">Monthly salary (PAYE)</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="incomeType" value="freelance" id="incomeFreelance" ${hasFreelance ? 'checked' : ''}>
                  <label for="incomeFreelance">Freelance / Contract work</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="incomeType" value="business" id="incomeBusiness" ${hasBusiness ? 'checked' : ''}>
                  <label for="incomeBusiness">Small business income</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="incomeType" value="foreign" id="incomeForeign" ${hasForeign ? 'checked' : ''}>
                  <label for="incomeForeign">Online / Foreign income</label>
                </div>
              </div>
            </div>
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Continue</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderSalary() {
      const hasPayslip = state.profile.hasPayslip === 'true';
      const hasPAYE = state.profile.hasPAYE === 'true';

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Let's talk about your salary. Do you have your payslips handy? If not, estimate is fine.
          </p>
          <form onsubmit="handleSalary(event)">
            <div class="form-group">
              <label>Do you have payslips available?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" name="hasPayslip" value="true" id="payslipYes" ${hasPayslip ? 'checked' : ''}>
                  <label for="payslipYes">Yes</label>
                </div>
                <div class="radio-item">
                  <input type="radio" name="hasPayslip" value="false" id="payslipNo" ${!hasPayslip ? 'checked' : ''}>
                  <label for="payslipNo">No (estimate is fine)</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>
                Total annual salary
                <span class="required">*</span>
                <span class="helper">Your total salary for the tax year</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="annualSalary" 
                placeholder="e.g. 2400000"
                value="${escapeHtml(state.profile.annualSalary || '')}"
                required
              >
            </div>
            <div class="form-group">
              <label>Was PAYE tax deducted from your salary?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" name="hasPAYE" value="true" id="payeYes" ${hasPAYE ? 'checked' : ''}>
                  <label for="payeYes">Yes</label>
                </div>
                <div class="radio-item">
                  <input type="radio" name="hasPAYE" value="false" id="payeNo" ${!hasPAYE ? 'checked' : ''}>
                  <label for="payeNo">No</label>
                </div>
              </div>
            </div>
            ${hasPAYE ? `
            <div class="form-group">
              <label>
                Total PAYE tax deducted
                <span class="helper">Total tax already deducted from your salary</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="payeDeducted" 
                placeholder="e.g. 150000"
                value="${escapeHtml(state.profile.payeDeducted || '')}"
              >
            </div>
            ` : ''}
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Continue</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderFreelance() {
      const hasExpenses = state.profile.hasExpenses === 'true';

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Tell me about your freelance or business income. Estimate is fine if you don't have exact numbers.
          </p>
          <form onsubmit="handleFreelance(event)">
            <div class="form-group">
              <label>
                Estimated annual freelance/business income
                <span class="required">*</span>
                <span class="helper">Total income from freelance work or small business</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="freelanceIncome" 
                placeholder="e.g. 1200000"
                value="${escapeHtml(state.profile.freelanceIncome || '')}"
                required
              >
            </div>
            <div class="form-group">
              <label>Did you have business expenses?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" name="hasExpenses" value="true" id="expensesYes" ${hasExpenses ? 'checked' : ''}>
                  <label for="expensesYes">Yes</label>
                </div>
                <div class="radio-item">
                  <input type="radio" name="hasExpenses" value="false" id="expensesNo" ${!hasExpenses ? 'checked' : ''}>
                  <label for="expensesNo">No</label>
                </div>
              </div>
            </div>
            ${hasExpenses ? `
            <div class="form-group">
              <label>
                Total business expenses
                <span class="helper">Office, supplies, travel, etc.</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="businessExpenses" 
                placeholder="e.g. 300000"
                value="${escapeHtml(state.profile.businessExpenses || '')}"
              >
            </div>
            ` : ''}
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Continue</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderForeignIncome() {
      const hasForeign = state.profile.hasForeignIncome === 'true';

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Did you earn any income from foreign sources or online work?
          </p>
          <form onsubmit="handleForeignIncome(event)">
            <div class="form-group">
              <label>Did you earn foreign/online income?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" name="hasForeignIncome" value="true" id="foreignYes" ${hasForeign ? 'checked' : ''}>
                  <label for="foreignYes">Yes</label>
                </div>
                <div class="radio-item">
                  <input type="radio" name="hasForeignIncome" value="false" id="foreignNo" ${!hasForeign ? 'checked' : ''}>
                  <label for="foreignNo">No</label>
                </div>
              </div>
            </div>
            ${hasForeign ? `
            <div class="form-group">
              <label>
                Total foreign/online income (in Naira)
                <span class="helper">Convert to Naira if needed</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="foreignIncome" 
                placeholder="e.g. 500000"
                value="${escapeHtml(state.profile.foreignIncome || '')}"
              >
            </div>
            ` : ''}
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Continue</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderReliefs() {
      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Let's check for additional reliefs and deductions you might be eligible for.
          </p>
          <form onsubmit="handleReliefs(event)">
            <div class="form-group">
              <label>
                Pension contributions (if any)
                <span class="helper">Total pension contributions for the year</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="pensionContributions" 
                placeholder="e.g. 240000"
                value="${escapeHtml(state.profile.pensionContributions || '')}"
              >
            </div>
            <div class="form-group">
              <label>
                National Housing Fund (NHF) contributions (if any)
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="nhfContributions" 
                placeholder="e.g. 12000"
                value="${escapeHtml(state.profile.nhfContributions || '')}"
              >
            </div>
            <div class="form-group">
              <label>
                Life insurance premiums (if any)
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="lifeInsurance" 
                placeholder="e.g. 50000"
                value="${escapeHtml(state.profile.lifeInsurance || '')}"
              >
            </div>
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Continue</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderTaxHistory() {
      const hasFiled = state.profile.hasFiledBefore === 'true';
      const hasTIN = state.profile.hasTIN === 'true';

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            A few quick questions about your tax history.
          </p>
          <form onsubmit="handleTaxHistory(event)">
            <div class="form-group">
              <label>Have you filed taxes before?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" name="hasFiledBefore" value="true" id="filedYes" ${hasFiled ? 'checked' : ''}>
                  <label for="filedYes">Yes</label>
                </div>
                <div class="radio-item">
                  <input type="radio" name="hasFiledBefore" value="false" id="filedNo" ${!hasFiled ? 'checked' : ''}>
                  <label for="filedNo">No, this is my first time</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Do you have a Tax Identification Number (TIN)?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" name="hasTIN" value="true" id="tinYes" ${hasTIN ? 'checked' : ''}>
                  <label for="tinYes">Yes</label>
                </div>
                <div class="radio-item">
                  <input type="radio" name="hasTIN" value="false" id="tinNo" ${!hasTIN ? 'checked' : ''}>
                  <label for="tinNo">No</label>
                </div>
              </div>
            </div>
            ${hasTIN ? `
            <div class="form-group">
              <label>
                Your TIN
                <span class="helper">Tax Identification Number</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                name="tinNumber" 
                placeholder="e.g. 12345678-0001"
                value="${escapeHtml(state.profile.tinNumber || '')}"
              >
            </div>
            ` : ''}
            <div class="button-group">
              <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
              <button type="submit" class="button button-primary">Review Summary</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderReview() {
      const taxCalc = NigerianTaxEngine.calculateTax(state.profile);
      const stateIRS = NigerianTaxEngine.getStateIRS(state.profile.primaryState || state.profile.currentState);
      const format = NigerianTaxEngine.formatCurrency;

      // Check for flags
      const flags = [];
      if (state.profile.hasFiledBefore === 'false') {
        flags.push({ type: 'info', message: 'First-time filer: You may need to register for a TIN if you don\'t have one.' });
      }
      if (state.profile.hasTIN === 'false') {
        flags.push({ type: 'warning', message: 'Missing TIN: You\'ll need to obtain a Tax Identification Number before filing.' });
      }
      if (state.profile.currentState !== state.profile.primaryState) {
        flags.push({ type: 'warning', message: 'Multi-state residency: You may need to file in both states. Consult a tax professional.' });
      }

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Here's your tax summary. Review these numbers carefully.
          </p>
          <div class="results-card">
            <div class="results-section">
              <h3>Income Summary</h3>
              ${state.profile.hasSalary ? `
              <div class="result-item">
                <span class="result-label">Salary Income</span>
                <span class="result-value">${format(NigerianTaxEngine.parseAmount(state.profile.annualSalary || 0))}</span>
              </div>
              ` : ''}
              ${state.profile.hasFreelance ? `
              <div class="result-item">
                <span class="result-label">Freelance/Business Income</span>
                <span class="result-value">${format(NigerianTaxEngine.parseAmount(state.profile.freelanceIncome || 0))}</span>
              </div>
              ` : ''}
              ${state.profile.hasForeignIncome === 'true' ? `
              <div class="result-item">
                <span class="result-label">Foreign/Online Income</span>
                <span class="result-value">${format(NigerianTaxEngine.parseAmount(state.profile.foreignIncome || 0))}</span>
              </div>
              ` : ''}
              <div class="result-item">
                <span class="result-label">Gross Income</span>
                <span class="result-value highlight">${format(taxCalc.grossIncome)}</span>
              </div>
            </div>

            <div class="results-section">
              <h3>Tax Calculation</h3>
              <div class="result-item">
                <span class="result-label">Consolidated Relief Allowance (CRA)</span>
                <span class="result-value">${format(taxCalc.cra)}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Taxable Income</span>
                <span class="result-value highlight">${format(taxCalc.taxableIncome)}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Tax Liability</span>
                <span class="result-value">${format(taxCalc.taxLiability)}</span>
              </div>
              ${taxCalc.payeOffset > 0 ? `
              <div class="result-item">
                <span class="result-label">PAYE Already Deducted</span>
                <span class="result-value">-${format(taxCalc.payeOffset)}</span>
              </div>
              ` : ''}
              <div class="result-item">
                <span class="result-label">Final Tax Due</span>
                <span class="result-value highlight">${format(taxCalc.finalTax)}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Effective Tax Rate</span>
                <span class="result-value">${taxCalc.effectiveRate}%</span>
              </div>
            </div>

            ${flags.length > 0 ? `
            <div class="results-section">
              <h3>Important Notes</h3>
              ${flags.map(flag => `
                <div class="flag ${flag.type}">
                  ${escapeHtml(flag.message)}
                </div>
              `).join('')}
            </div>
            ` : ''}
          </div>

          <div class="button-group">
            <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
            <button type="button" class="button button-primary" onclick="goToNext('compliance')">Continue</button>
          </div>
        </div>
      `;
    }

    function renderCompliance() {
      const stateIRS = NigerianTaxEngine.getStateIRS(state.profile.primaryState || state.profile.currentState);
      const taxCalc = NigerianTaxEngine.calculateTax(state.profile);
      const format = NigerianTaxEngine.formatCurrency;

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Here's what you need to do next to stay compliant.
          </p>
          <div class="results-card">
            <div class="results-section">
              <h3>Submission Information</h3>
              <div class="result-item">
                <span class="result-label">State IRS</span>
                <span class="result-value">${escapeHtml(stateIRS.name)}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Address</span>
                <span class="result-value" style="font-size: 12px; text-align: right;">${escapeHtml(stateIRS.address)}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Website</span>
                <span class="result-value" style="font-size: 12px;">${escapeHtml(stateIRS.website)}</span>
              </div>
            </div>

            <div class="results-section">
              <h3>Next Steps</h3>
              <div style="font-size: 13px; line-height: 1.6; color: var(--color-text);">
                <p style="margin-bottom: var(--spacing-md);">1. <strong>Review your tax summary</strong> - Make sure all numbers are correct</p>
                <p style="margin-bottom: var(--spacing-md);">2. <strong>Prepare documents</strong> - Gather payslips, receipts, and income statements</p>
                <p style="margin-bottom: var(--spacing-md);">3. <strong>Submit to ${escapeHtml(stateIRS.name)}</strong> - Visit their office or website</p>
                ${taxCalc.finalTax > 0 ? `
                <p style="margin-bottom: var(--spacing-md);">4. <strong>Pay tax due</strong> - ${format(taxCalc.finalTax)} (if applicable)</p>
                ` : `
                <p style="margin-bottom: var(--spacing-md);">4. <strong>No additional tax due</strong> - You've already paid through PAYE</p>
                `}
                <p>5. <strong>Keep records</strong> - Save all documents for at least 6 years</p>
              </div>
            </div>
          </div>

          <div class="button-group">
            <button type="button" class="button button-subtle" onclick="goToPrevious()">Back</button>
            <button type="button" class="button button-primary" onclick="goToNext('output')">Get Documents</button>
          </div>
        </div>
      `;
    }

    function renderOutput() {
      const taxCalc = NigerianTaxEngine.calculateTax(state.profile);
      const format = NigerianTaxEngine.formatCurrency;

      return `
        <div class="chat-card">
          <p class="assistant-bubble">
            Your tax filing summary is ready! You can export this information to share with your accountant or keep for your records.
          </p>
          <div class="summary-actions">
            <button class="button button-primary button-full" onclick="exportTaxSummary()">
              Download Tax Summary (Copy to Clipboard)
            </button>
            <button class="button button-subtle button-full" onclick="goToNext('welcome')">
              Start Over
            </button>
          </div>
          <p class="helper-text">Remember: This is a guidance tool. Always consult a tax professional before filing.</p>
        </div>
      `;
    }

    function renderStep() {
      const currentStep = interviewSteps[state.currentStepIndex];
      switch (currentStep) {
        case 'welcome':
          return renderWelcome();
        case 'residency':
          return renderResidency();
        case 'incomeType':
          return renderIncomeType();
        case 'salary':
          if (state.profile.incomeTypes?.includes('salary')) {
            return renderSalary();
          } else {
            // Skip salary if not selected, go to freelance
            if (state.profile.incomeTypes?.includes('freelance') || state.profile.incomeTypes?.includes('business')) {
              return renderFreelance();
            } else {
              return renderForeignIncome();
            }
          }
        case 'freelance':
          if (state.profile.incomeTypes?.includes('freelance') || state.profile.incomeTypes?.includes('business')) {
            return renderFreelance();
          } else {
            return renderForeignIncome();
          }
        case 'foreignIncome':
          if (state.profile.incomeTypes?.includes('foreign')) {
            return renderForeignIncome();
          } else {
            return renderReliefs();
          }
        case 'reliefs':
          return renderReliefs();
        case 'taxHistory':
          return renderTaxHistory();
        case 'review':
          return renderReview();
        case 'compliance':
          return renderCompliance();
        case 'output':
          return renderOutput();
        default:
          return '';
      }
    }

    function render() {
      const stream = document.getElementById('conversationStream');
      const messagesHtml = state.messages.map(renderMessage).join('');
      const stepHtml = renderStep();
      stream.innerHTML = messagesHtml + stepHtml;
    }

    // Event handlers
    function handleResidency(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      state.profile.currentState = formData.get('currentState');
      state.profile.primaryState = formData.get('primaryState');
      goToNext('incomeType', 'Completed residency information');
    }

    function handleIncomeType(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const incomeTypes = formData.getAll('incomeType');
      state.profile.incomeTypes = incomeTypes;
      state.profile.hasSalary = incomeTypes.includes('salary');
      state.profile.hasFreelance = incomeTypes.includes('freelance') || incomeTypes.includes('business');
      state.profile.hasForeignIncome = incomeTypes.includes('foreign') ? 'true' : 'false';
      
      // Determine next step based on income types
      if (state.profile.hasSalary) {
        goToNext('salary', 'Selected income types');
      } else if (state.profile.hasFreelance) {
        goToNext('freelance', 'Selected income types');
      } else if (state.profile.hasForeignIncome === 'true') {
        goToNext('foreignIncome', 'Selected income types');
      } else {
        goToNext('reliefs', 'Selected income types');
      }
    }

    function handleSalary(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      state.profile.hasPayslip = formData.get('hasPayslip');
      state.profile.annualSalary = formData.get('annualSalary');
      state.profile.hasPAYE = formData.get('hasPAYE');
      state.profile.payeDeducted = formData.get('payeDeducted');
      
      // Determine next step
      if (state.profile.hasFreelance) {
        goToNext('freelance', 'Completed salary information');
      } else if (state.profile.hasForeignIncome === 'true') {
        goToNext('foreignIncome', 'Completed salary information');
      } else {
        goToNext('reliefs', 'Completed salary information');
      }
    }

    function handleFreelance(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      state.profile.freelanceIncome = formData.get('freelanceIncome');
      state.profile.hasExpenses = formData.get('hasExpenses');
      state.profile.businessExpenses = formData.get('businessExpenses');
      
      if (state.profile.hasForeignIncome === 'true') {
        goToNext('foreignIncome', 'Completed freelance information');
      } else {
        goToNext('reliefs', 'Completed freelance information');
      }
    }

    function handleForeignIncome(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      state.profile.hasForeignIncome = formData.get('hasForeignIncome');
      state.profile.foreignIncome = formData.get('foreignIncome');
      goToNext('reliefs', 'Completed foreign income information');
    }

    function handleReliefs(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      state.profile.pensionContributions = formData.get('pensionContributions');
      state.profile.nhfContributions = formData.get('nhfContributions');
      state.profile.lifeInsurance = formData.get('lifeInsurance');
      goToNext('taxHistory', 'Completed reliefs section');
    }

    function handleTaxHistory(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      state.profile.hasFiledBefore = formData.get('hasFiledBefore');
      state.profile.hasTIN = formData.get('hasTIN');
      state.profile.tinNumber = formData.get('tinNumber');
      goToNext('review', 'Completed tax history');
    }

    function exportTaxSummary() {
      const taxCalc = NigerianTaxEngine.calculateTax(state.profile);
      const stateIRS = NigerianTaxEngine.getStateIRS(state.profile.primaryState || state.profile.currentState);
      const format = NigerianTaxEngine.formatCurrency;
      
      let text = `PERSONAL INCOME TAX SUMMARY - NIGERIA\n`;
      text += `==========================================\n\n`;
      text += `Tax Year: ${new Date().getFullYear() - 1}\n`;
      text += `State: ${state.profile.primaryState || state.profile.currentState}\n`;
      text += `State IRS: ${stateIRS.name}\n\n`;
      text += `INCOME SUMMARY\n`;
      text += `-------------\n`;
      if (state.profile.hasSalary) {
        text += `Salary Income: ${format(NigerianTaxEngine.parseAmount(state.profile.annualSalary || 0))}\n`;
      }
      if (state.profile.hasFreelance) {
        text += `Freelance/Business Income: ${format(NigerianTaxEngine.parseAmount(state.profile.freelanceIncome || 0))}\n`;
      }
      if (state.profile.hasForeignIncome === 'true') {
        text += `Foreign/Online Income: ${format(NigerianTaxEngine.parseAmount(state.profile.foreignIncome || 0))}\n`;
      }
      text += `Gross Income: ${format(taxCalc.grossIncome)}\n\n`;
      text += `TAX CALCULATION\n`;
      text += `---------------\n`;
      text += `Consolidated Relief Allowance (CRA): ${format(taxCalc.cra)}\n`;
      text += `Taxable Income: ${format(taxCalc.taxableIncome)}\n`;
      text += `Tax Liability: ${format(taxCalc.taxLiability)}\n`;
      if (taxCalc.payeOffset > 0) {
        text += `PAYE Already Deducted: ${format(taxCalc.payeOffset)}\n`;
      }
      text += `Final Tax Due: ${format(taxCalc.finalTax)}\n`;
      text += `Effective Tax Rate: ${taxCalc.effectiveRate}%\n\n`;
      text += `SUBMISSION INFORMATION\n`;
      text += `---------------------\n`;
      text += `State IRS: ${stateIRS.name}\n`;
      text += `Address: ${stateIRS.address}\n`;
      text += `Website: ${stateIRS.website}\n`;
      text += `Phone: ${stateIRS.phone}\n\n`;
      text += `DISCLAIMER\n`;
      text += `----------\n`;
      text += `This is a tax guidance tool. Always consult with a qualified tax professional or your State IRS before filing. This summary is for preparation purposes only.\n`;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert('Tax summary copied to clipboard!');
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        alert('Tax summary copied to clipboard!');
      } catch (err) {
        alert('Could not copy. Please select and copy the text manually.');
      }
      document.body.removeChild(textarea);
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Make functions globally available
    window.goToNext = goToNext;
    window.goToPrevious = goToPrevious;
    window.handleResidency = handleResidency;
    window.handleIncomeType = handleIncomeType;
    window.handleSalary = handleSalary;
    window.handleFreelance = handleFreelance;
    window.handleForeignIncome = handleForeignIncome;
    window.handleReliefs = handleReliefs;
    window.handleTaxHistory = handleTaxHistory;
    window.exportTaxSummary = exportTaxSummary;

    // Initial render
    render();
    updateProgress();
    scrollToBottom();
  </script>
</body>
</html>
